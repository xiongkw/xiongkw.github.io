---
layout: post
title: Kafka在nat网络下的问题
categories: [编程, java]
tags: [kafka, nat]
---

> 有一个奇葩的网络环境，`kafka-server`和`client`不在同一网段，并且`client`要通过`nat`端口映射才能访问`server`

#### 1. 环境

把外网端口`19092`映射到内网端口`9092`

| 角色 |   内网  |  外网 |
| -------- | -------------------| ------------------------------ |
| kafka-server | 192.168.1.191:9092 | 130.108.186.130:19092 |
| client | 192.168.56.100 | |

#### 2. 问题

> `client`端通过`broker-list: 130.108.186.130:19092`访问`server`时出现`Timeout`异常

通过日志分析，查看到`client`虽然指明了`broker-list`为外网地址，但实际访问的却是内网地址，原因是其取了`zookeeper`中的`broker`

#### 3. 修改advertised.listeners

修改参数`advertised.listeners`，指定注册到`zk`的为外网地址

server.properties
```
advertised.listeners=PLAINTEXT://130.108.186.130:19092
```

重启发现异常

```
Number of alive brokers '0' does not meet the required replication factor '1'
```

> 原因是`kafka`会通过`zk`中指定的地址做健康检查，但是从本机是无法访问外网地址的，于是想到通过域名实现

#### 4. 使用域名

server.properties
```
advertised.listeners=PLAINTEXT://kafka-server:19092
```

/etc/hosts
```
127.0.0.1   kafka-server
```

> `kafka-server`能访问了，但是端口`19092`还是无法访问，继续端口映射

#### 5. 端口映射

通过`iptables`把`19092`端口映射到`9092`端口

```
iptables -A OUTPUT -t nat -p tcp --dport 19092 -j REDIRECT --to 9092
```

> 重启`kafka-server`，启动成功

#### 6. client

编辑/etc/hosts
```
127.0.0.1   kafka-server
```

> 至此问题解决，同时也再一次证明：变态的需求永远会有

#### 7. 参考

* [Kafka configuration](http://kafka.apache.org/documentation/#configuration)