---
layout: post
title: spring自定义命名空间
categories: [编程, java]
tags: [java, spi]
---

> `面向接口编程`是一种良好的编码习惯，在spring中可以借助`DI`实现。   
> jdk制定了jdbc的接口，而各数据库的厂商则要实现jdbc接口。使用者只需使用jdbc标准接口编码，而不需要关心具体的实现（其实也是要关心的，不过本文中忽略）

### 1. 传统jdbc写法
先看jdbc的api写法
```java
Class.forName("com.mysql.jdbc.Driver");
Connection conn = DriverManager.getConnection();
```
疑问：Class.forName是什么用处？看com.mysql.jdbc.Driver源码
```java
static {
    try {
        java.sql.DriverManager.registerDriver(new Driver());
    } catch (SQLException E) {
        throw new RuntimeException("Can't register driver!");
    }
}
```
再看DriverManager.getConnection()实现
```java
for(DriverInfo aDriver : registeredDrivers) {
    // If the caller does not have permission to load the driver then
    // skip it.
    if(isDriverAllowed(aDriver.driver, callerCL)) {
        try {
            println("    trying " + aDriver.driver.getClass().getName());
            Connection con = aDriver.driver.connect(url, info);
            if (con != null) {
                // Success!
                println("getConnection returning " + aDriver.driver.getClass().getName());
                return (con);
            }
        } catch (SQLException ex) {
            if (reason == null) {
                reason = ex;
            }
        }

    } else {
        println("    skipping: " + aDriver.getClass().getName());
    }
}
```
* mysql Driver在其static块中向DriverManager注册了一个mysql的Driver   
* jdk的DriverManager在实例化Connection时使用已经注册的mysql Driver实现

> 比较丑陋的是必须要调用Class.forName()，也就是在编码时已经知道db是mysql了，虽然不是在编译时直接依赖。

### 2. druid的写法
> druid是阿里巴巴开源的一个数据库连接池组件，不同于commons-dbcp的是druid不需要配置driverClass属性

```java
public static String getDriverClassName(String rawUrl) throws SQLException {
        if (rawUrl.startsWith("jdbc:derby:")) {
            return "org.apache.derby.jdbc.EmbeddedDriver";
        } else if (rawUrl.startsWith("jdbc:mysql:")) {
            return MYSQL_DRIVER;
        } else if (rawUrl.startsWith("jdbc:log4jdbc:")) {
            return LOG4JDBC_DRIVER;
        } else if (rawUrl.startsWith("jdbc:mariadb:")) {
            return MARIADB_DRIVER;
        //...
        } else {
            throw new SQLException("unkow jdbc driver : " + rawUrl);
        }
    }
```
* druid 通过配置项url来识别具体的jdbc实现，所以这里穷举了所有常见的jdbc实现。如果厂商又出了一个新的jdbc实现，druid是无法识别的。

### 3. spi的方式
DriverManager
```java
public class SpiDriverManager {

    public static Connection getConnection(String url, Properties props) throws SQLException {
        ServiceLoader<Driver> drivers = ServiceLoader.load(Driver.class);
        Iterator<Driver> iterator = drivers.iterator();
        if (iterator.hasNext()) {
            return iterator.next().connect(url, props);
        }
        throw new RuntimeException("No jdbc Driver found in classpath!");
    }

}
```
同时，jdbc实现jar里需要增加资源文件`META-INF/services/java.sql.Driver`

例如mysql
```
com.mysql.jdbc.Driver
```
oracle
```
oracle.jdbc.driver.OracleDriver
```

* spi实现了完全的即插即用，面向接口编程，在classpath中搜索实现类。
* 会搜索到所有的实现类，所以需要注意不要同时依赖多个实现组件。