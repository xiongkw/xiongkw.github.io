---
layout: post
title: 自动化部署之ansible和docker
categories: [编程, linux, docker]
tags: [ansible]
---

> 最近被分配了一个光荣且艰巨(che dan qie keng die)的任务，非容器化部署某项目组的一个大型项目，且不论让一帮外行接手专业项目部署的合理性合法性以及`996`和`906`工作强度的人道性，只谈非容器化，在容器化大行其道的今天，本人认为这就是历史的倒退，以`nginx`为例

#### 1. 非容器化部署

正常情况下，使用以下脚本可以成功安装`nginx`

```
yum -y install gcc gcc-c++ make pcre-devel zlib-devel -y
tar -zxvf nginx-1.16.1.tar.gz -C /tmp
cd /tmp/nginx-1.16.1
./configure --with-stream --with-stream_ssl_module --prefix=/app/nginx-1.16.1
make && make install
```

> 但经验告诉我们，真实的部署环境永远是非正常的

#### 2. 非正常情况

##### 2.1 安装目录不存在

当目录不存在时，我们可以加一行命令自动创建

```
mkdir -p /app
```

##### 2.2 安装目录已存在

当目录已经存在其它文件时，我们仍然可以霸道的清空它而不管它是否正在被使用，例如：

```
rm -rf /app/nginx-1.16.1
```

##### 2.3 yum无法访问外网

大部分生产环境是无法访问外网的，所以你只能祈祷管理员可以为你开一个代理，但你可能要自己登录主机上修改`yum`配置

```
[main]
proxy=http://192.168.1.100:3128
```

##### 2.4 yum源的问题

有些包需要特定的`yum`源，例如`epel-release`，一个勉强的办法是预先安装

```
yum install epel-release -y
```

但是由此又会引入新的问题：不指定版本安装时，有的包可能会安装`epel-release`源中的最新版本

##### 2.5 操作系统问题

在`CentOS`下，我们可以用`yum`，但如果客户提供的是`Ubuntu`，那我们就要改写脚本了

#### 3. 容器化部署

使用`docker`命令启动一个`nginx`容器

```
docker run --name nginx -d nginx:1.16.1
```

> 只要一行命令就可以了，当然需要预先制作镜像以及安装`docker runtime`

#### 4. 非容器化和容器化处理非正常因素的对比

|问题|非容器|容器化|
|----|----|----|
|安装目录不存在|加一行命令自动创建<br>mkdir -p /app|不可能|
|安装目录已存在|霸道的清空它而不管它是否正在被使用<br>rm -rf /app/nginx-1.16.1|不存在|
|yum无法访问外网|祈祷管理员可以为你开一个后门|不需要|
|yum源的问题|加一行命令预先安装<br>yum install epel-release -y|不需要|
|操作系统问题|需要兼容不同操作系统|不考虑|

#### 5. 总结

##### 5.1 概率和打包

1. 一个任务分解成5个小任务，如果每个小任务失败的概率为`10%`，则该任务失败的概率为`50%`

2. 打包的目的是把多个小任务打包成一个任务，把每个不确定的因素都确定下来，同时能够屏蔽内部细节

##### 5.2 运维与运维

部署是一时，运维是一世，这里的运维有两个方面：其一是部署脚本自身的运维，其二是对所部署软件的运维

1. 部署脚本的代码量直接影响着被骂的频度

2. 部署步骤的多少直接影响着被骂的强度

> 严格的讲，运维和部署无关，但经验告诉我们，不考虑运维的部署就是耍流氓

##### 5.3 其它

作为一个`IT`民工，我本不该怀疑领导们的英明决策，但是作为一个程序猿，我得努力的为自己和他人负责

> 猿生最大的悲哀不是被`996`和`ICU`，而是即便是`996`和`ICU`也不能换来一个简单易懂的傻瓜安装包
