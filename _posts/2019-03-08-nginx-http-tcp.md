---
layout: post
title: nginx反向代理之http和tcp的比较
categories: [编程, nginx]
tags: [proxy, tcp]
---

> `nginx`从`1.9.0`开始支持四层代理了，一般来说四层代理的性能要优于七层，那么是否可以取代`http`代理呢

#### 1. 概述

* 目的：比较`http`和`stream`模式代理的性能

* 约束：单纯只比较代理性能，不考虑其它优化情况，例如`http`模式下的缓存等

#### 2. 测试数据

##### 2.1 backend

| 响应大小 |   c100  |  c200 |  c500 |
| -------- | --------- | --------- | ---------- |
| 10k | 15076 | 14180 | 10692 |
| 100k| 5923 | 5746 | 5241 |

> 压测`backend`

##### 2.2 http->backend

| 响应大小 |   c100  |  c200 |  c500 |
| -------- | --------- | --------- | ---------- |
| 10k | 8933 | 8941 | 8893 |
| 100k| 3002 | 2624 | 2689 |

> 使用`http`模式代理`backend`的情况，测试命令：`ab -n 100000 -c 100 -k`    
> `nginx`到`upstream`配置了`keepalive`

##### 2.2 stream->backend

| 响应大小 |   c100  |  c200 |  c500 |
| -------- | --------- | --------- | ---------- |
| 10k | 12971 | 11632 | 10242 |
| 100k| 3297 | 2948 | 2844 |

> 使用`stream`模式代理`backend`的情况，测试命令：`ab -n 100000 -c 100 -k`

#### 3. 分析

* 并发数小于`1000`时，`stream`性能比`http`好
* 随着并发数和响应`body`逐渐增大，`stream`性能下降，最后明显低于`http`
* 比较`nginx`到`backend`的`tcp`连接数，发现`http`一直稳定在`1000`，而`stream`则基本等于并发数，说明`http`模式重用了后端连接，而`stream`不重用

结论：除去`http`代理的高级特性(例如`gzip，cache`等)之后，`stream`也无法完全取代`http`代理，`stream`适用于并发量不大的小报文长连接，`http`适用于并发量大的短连接，这正是传统`tcp`与`http`服务的应用场景区别
